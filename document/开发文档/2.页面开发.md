# 页面开发

本文档详细说明如何开发业务页面，包括 Am 组件的使用、CSS 变量规范和页面开发流程。

我们以**商品管理模块（Product）**为例进行说明。

## 1. Am 组件库

项目封装了一系列 Am 组件，提供更便捷的使用方式和更丰富的功能。

### 1.1 组件列表

**基础组件：**
- [AmButton](../Am组件/AmButton.md) - 增强按钮组件，支持自动 loading
- [AmCard](../Am组件/AmCard.md) - 增强卡片组件，灵活的内边距控制
- [AmDialog](../Am组件/AmDialog.md) - 增强对话框组件，灵活的内边距控制
- [AmAvatar](../Am组件/AmAvatar.md) - 头像组件，支持单个和头像组模式
- [AmActionLinks](../Am组件/AmActionLinks.md) - 操作链接组件，用于表格操作列

**表格相关组件：**
- [AmSortHeader](../Am组件/AmSortHeader.md) - 可排序表头组件
- [AmFilterHeader](../Am组件/AmFilterHeader.md) - 可筛选表头组件
- [AmHeaderIcon](../Am组件/AmHeaderIcon.md) - 表头图标组件

### 1.2 快速开始

```vue
<script setup lang="ts">
import AmButton from '@/components/basic/AmButton.vue'
import AmCard from '@/components/basic/AmCard.vue'
import AmDialog from '@/components/basic/AmDialog.vue'
</script>

<template>
  <AmCard :padding="20">
    <h3>标题</h3>
    <p>内容</p>
    <AmButton auto-loading @click="handleSubmit">
      提交
    </AmButton>
  </AmCard>
</template>
```

## 2. CSS 变量规范

项目定义了完整的 CSS 变量系统，确保样式的一致性和可维护性。

### 2.1 变量定义位置

CSS 变量定义在 `src/assets/style/` 目录下：

```
src/assets/style/
├── size/
│   ├── spacing/gap-size.css      # 间距变量
│   ├── font/font-size.css        # 字体大小变量
│   ├── dimensions/               # 尺寸变量
│   └── ...
├── color/
│   ├── dynamic-color-variables.css  # 动态主题色变量
│   ├── light-theme.css             # 浅色主题
│   ├── dark-theme.css              # 深色主题
│   └── ...
└── ...
```

### 2.2 常用变量类型

**间距变量：** `--gap-size-xs` ~ `--gap-size-3xl`  
**字体变量：** `--font-size-xs` ~ `--font-size-3xl`  
**颜色变量：** `--am-primary`、`--am-bg-color`、`--am-border-color` 等  
**圆角变量：** `--radius-xs` ~ `--radius-xl`、`--radius-card`、`--radius-input` 等

**详细变量列表请查看对应的 CSS 文件。**

### 2.3 使用示例

```vue
<style scoped>
.product-list {
  /* 使用间距变量 */
  .search-card,
  .toolbar-card,
  .table-card {
    margin-bottom: var(--gap-size-xl);
  }
  
  /* 使用颜色变量 */
  .status-badge {
    background-color: var(--am-primary-light-7);
    color: var(--am-primary);
    border: 1px solid var(--am-border-color-light);
  }
  
  /* 使用圆角变量 */
  .custom-card {
    border-radius: var(--radius-card);
  }
}
</style>
```

## 3. 完整页面示例

### 3.1 商品列表页面

创建 `src/views/product/ProductList.vue`：

```vue
<template>
  <div class="product-list">
    <!-- 搜索栏 -->
    <AmCard class="search-card">
      <el-form :model="searchForm" inline>
        <el-form-item label="商品名称">
          <el-input 
            v-model="searchForm.name" 
            placeholder="请输入商品名称"
            clearable
          />
        </el-form-item>
        <el-form-item label="状态">
          <el-select 
            v-model="searchForm.status" 
            placeholder="请选择状态"
            clearable
          >
            <el-option label="上架" :value="1" />
            <el-option label="下架" :value="0" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <AmButton type="primary" @click="handleSearch">
            <el-icon><Search /></el-icon>
            搜索
          </AmButton>
          <AmButton @click="handleReset">
            <el-icon><Refresh /></el-icon>
            重置
          </AmButton>
        </el-form-item>
      </el-form>
    </AmCard>

    <!-- 操作栏 -->
    <AmCard class="toolbar-card">
      <AmButton 
        type="primary" 
        @click="handleAdd"
        v-permission="'product:add'"
      >
        <el-icon><Plus /></el-icon>
        添加商品
      </AmButton>
      <AmButton 
        type="danger" 
        :disabled="selectedIds.length === 0"
        @click="handleBatchDelete"
        v-permission="'product:delete'"
      >
        <el-icon><Delete /></el-icon>
        批量删除
      </AmButton>
    </AmCard>

    <!-- 表格 -->
    <AmCard class="table-card" no-padding>
      <el-table
        :data="tableData"
        :loading="loading"
        @selection-change="handleSelectionChange"
        stripe
      >
        <el-table-column type="selection" width="55" />
        <el-table-column prop="id" label="ID" width="80" />
        <el-table-column prop="name" label="商品名称" min-width="150" />
        <el-table-column prop="price" label="价格" width="120">
          <template #default="{ row }">
            ¥{{ row.price.toFixed(2) }}
          </template>
        </el-table-column>
        <el-table-column prop="stock" label="库存" width="100" />
        <el-table-column prop="statusText" label="状态" width="100">
          <template #default="{ row }">
            <el-tag :type="row.status === 1 ? 'success' : 'info'">
              {{ row.statusText }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column label="操作" width="200" fixed="right">
          <template #default="{ row }">
            <el-button 
              link 
              type="primary" 
              @click="handleEdit(row)"
              v-permission="'product:edit'"
            >
              编辑
            </el-button>
            <el-button 
              link 
              type="danger" 
              @click="handleDelete(row)"
              v-permission="'product:delete'"
            >
              删除
            </el-button>
          </template>
        </el-table-column>
      </el-table>

      <div class="pagination-wrapper">
        <el-pagination
          v-model:current-page="pagination.pageNum"
          v-model:page-size="pagination.pageSize"
          :total="total"
          :page-sizes="[10, 20, 50, 100]"
          layout="total, sizes, prev, pager, next, jumper"
          @size-change="loadData"
          @current-change="loadData"
        />
      </div>
    </AmCard>

    <!-- 添加/编辑对话框 -->
    <ProductDialog
      :visible="dialogVisible"
      :product="currentProduct"
      @update:visible="dialogVisible = $event"
      @success="handleDialogSuccess"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import api from '@/services'
import { ElMessageBox } from 'element-plus'
import { Search, Refresh, Plus, Delete } from '@element-plus/icons-vue'
import AmButton from '@/components/basic/AmButton.vue'
import AmCard from '@/components/basic/AmCard.vue'
import ProductDialog from './components/ProductDialog.vue'
import type { ProductVO } from '@/services'

// 数据
const tableData = ref<ProductVO[]>([])
const loading = ref(false)
const total = ref(0)

const searchForm = reactive({
  name: '',
  status: undefined as number | undefined
})

const pagination = reactive({
  pageNum: 1,
  pageSize: 10
})

const selectedIds = ref<number[]>([])
const dialogVisible = ref(false)
const currentProduct = ref<ProductVO | null>(null)

// 方法
const loadData = async () => {
  loading.value = true
  try {
    const res = await api.product.getProducts({
      pageNum: pagination.pageNum,
      pageSize: pagination.pageSize,
      data: searchForm
    })
    tableData.value = res.records
    total.value = res.total
  } finally {
    loading.value = false
  }
}

const handleSearch = () => {
  pagination.pageNum = 1
  loadData()
}

const handleReset = () => {
  searchForm.name = ''
  searchForm.status = undefined
  pagination.pageNum = 1
  loadData()
}

const handleAdd = () => {
  currentProduct.value = null
  dialogVisible.value = true
}

const handleEdit = (row: ProductVO) => {
  currentProduct.value = row
  dialogVisible.value = true
}

const handleDelete = async (row: ProductVO) => {
  try {
    await ElMessageBox.confirm(
      `确定要删除商品"${row.name}"吗？`,
      '提示',
      { type: 'warning' }
    )
    await api.product.deleteProducts([row.id])
    loadData()
  } catch {
    // 用户取消
  }
}

const handleBatchDelete = async () => {
  try {
    await ElMessageBox.confirm(
      `确定要删除选中的 ${selectedIds.value.length} 个商品吗？`,
      '提示',
      { type: 'warning' }
    )
    await api.product.deleteProducts(selectedIds.value)
    selectedIds.value = []
    loadData()
  } catch {
    // 用户取消
  }
}

const handleSelectionChange = (selection: ProductVO[]) => {
  selectedIds.value = selection.map(item => item.id)
}

const handleDialogSuccess = () => {
  dialogVisible.value = false
  loadData()
}

onMounted(() => {
  loadData()
})
</script>

<style scoped>
.product-list {
  /* 使用 CSS 变量定义间距 */
  .search-card,
  .toolbar-card,
  .table-card {
    margin-bottom: var(--gap-size-xl);
  }

  /* 分页容器 */
  .pagination-wrapper {
    padding: var(--gap-size-xl);
    display: flex;
    justify-content: flex-end;
  }
}
</style>
```

### 3.2 商品对话框组件

创建 `src/views/product/components/ProductDialog.vue`：

```vue
<template>
  <AmDialog
    v-model:visible="visible"
    :title="isEdit ? '编辑商品' : '添加商品'"
    width="600px"
    @close="handleClose"
  >
    <el-form
      ref="formRef"
      :model="formData"
      :rules="rules"
      label-width="100px"
    >
      <el-form-item label="商品名称" prop="name">
        <el-input 
          v-model="formData.name" 
          placeholder="请输入商品名称"
          maxlength="100"
          show-word-limit
        />
      </el-form-item>

      <el-form-item label="商品描述" prop="description">
        <el-input
          v-model="formData.description"
          type="textarea"
          :rows="3"
          placeholder="请输入商品描述"
          maxlength="500"
          show-word-limit
        />
      </el-form-item>

      <el-form-item label="商品价格" prop="price">
        <el-input-number
          v-model="formData.price"
          :min="0.01"
          :max="999999.99"
          :precision="2"
          :step="0.01"
          controls-position="right"
        />
      </el-form-item>

      <el-form-item label="库存数量" prop="stock">
        <el-input-number
          v-model="formData.stock"
          :min="0"
          :step="1"
          controls-position="right"
        />
      </el-form-item>

      <el-form-item label="商品分类" prop="categoryId">
        <el-select 
          v-model="formData.categoryId" 
          placeholder="请选择分类"
          clearable
        >
          <el-option label="电子产品" :value="1" />
          <el-option label="服装鞋帽" :value="2" />
          <el-option label="食品饮料" :value="3" />
        </el-select>
      </el-form-item>
    </el-form>

    <template #footer>
      <el-button @click="handleClose">取消</el-button>
      <AmButton type="primary" auto-loading @click="handleSubmit">
        确定
      </AmButton>
    </template>
  </AmDialog>
</template>

<script setup lang="ts">
import { ref, reactive, watch } from 'vue'
import api from '@/services'
import AmDialog from '@/components/basic/AmDialog.vue'
import AmButton from '@/components/basic/AmButton.vue'
import type { FormInstance, FormRules } from 'element-plus'
import type { ProductVO, AddProductDTO, UpdateProductDTO } from '@/services'

interface Props {
  visible: boolean
  product?: ProductVO | null
}

const props = withDefaults(defineProps<Props>(), {
  product: null
})

const emit = defineEmits<{
  'update:visible': [value: boolean]
  'success': []
}>()

const formRef = ref<FormInstance>()
const isEdit = ref(false)

const formData = reactive<AddProductDTO>({
  name: '',
  description: '',
  price: 0,
  stock: 0,
  categoryId: undefined,
  imageUrl: ''
})

const rules: FormRules = {
  name: [
    { required: true, message: '请输入商品名称', trigger: 'blur' },
    { min: 1, max: 100, message: '长度在 1 到 100 个字符', trigger: 'blur' }
  ],
  price: [
    { required: true, message: '请输入商品价格', trigger: 'blur' },
    { type: 'number', min: 0.01, message: '价格必须大于0', trigger: 'blur' }
  ],
  stock: [
    { required: true, message: '请输入库存数量', trigger: 'blur' },
    { type: 'number', min: 0, message: '库存不能为负数', trigger: 'blur' }
  ]
}

watch(
  () => props.product,
  (newVal) => {
    if (newVal) {
      isEdit.value = true
      Object.assign(formData, {
        name: newVal.name,
        description: newVal.description,
        price: newVal.price,
        stock: newVal.stock,
        categoryId: newVal.categoryId,
        imageUrl: newVal.imageUrl
      })
    } else {
      isEdit.value = false
      resetForm()
    }
  },
  { immediate: true }
)

const resetForm = () => {
  formData.name = ''
  formData.description = ''
  formData.price = 0
  formData.stock = 0
  formData.categoryId = undefined
  formData.imageUrl = ''
  formRef.value?.clearValidate()
}

const handleClose = () => {
  emit('update:visible', false)
  resetForm()
}

const handleSubmit = async () => {
  if (!formRef.value) return

  await formRef.value.validate(async (valid) => {
    if (!valid) return

    if (isEdit.value && props.product) {
      const updateData: UpdateProductDTO = {
        id: props.product.id,
        ...formData
      }
      await api.product.updateProduct(updateData)
    } else {
      await api.product.addProduct(formData)
    }
    
    emit('success')
    handleClose()
  })
}
</script>
```

## 4. 样式开发规范

### 4.1 优先使用 CSS 变量

```vue
<style scoped>
/* ✅ 推荐：使用 CSS 变量 */
.card {
  padding: var(--gap-size-xl);
  border-radius: var(--radius-card);
  background-color: var(--am-bg-color-overlay);
}

/* ❌ 不推荐：硬编码值 */
.card {
  padding: 20px;
  border-radius: 15px;
  background-color: #ffffff;
}
</style>
```

### 4.2 间距规范

```vue
<style scoped>
/* 卡片间距 */
.card-list {
  gap: var(--gap-size-xl);  /* 20px */
}

/* 表单项间距 */
.form-item {
  margin-bottom: var(--gap-size-lg);  /* 15px */
}

/* 按钮间距 */
.button-group {
  gap: var(--gap-size-md);  /* 12px */
}

/* 小间距 */
.icon-text {
  gap: var(--gap-size-sm);  /* 8px */
}
</style>
```

### 4.3 响应式布局

```vue
<style scoped>
.product-list {
  display: flex;
  flex-direction: column;
  gap: var(--gap-size-xl);
}

/* 使用 flex 布局 */
.toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: var(--gap-size-md);
}

/* 使用 grid 布局 */
.card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: var(--gap-size-xl);
}
</style>
```

## 5. 配置菜单路由

本项目使用**动态路由**，路由配置通过后端菜单管理实现。

### 5.1 在菜单管理中添加路由

访问 **权限管理 → 菜单管理**，添加新的菜单项：

**步骤 1：添加目录（可选）**

如果需要创建一级菜单目录：

| 字段 | 值 | 说明 |
|------|-----|------|
| 菜单名称 | 商品管理 | 显示在侧边栏的名称 |
| 菜单类型 | 目录 | 一级菜单 |
| 图标 | Goods | Element Plus 图标名 |
| 排序 | 10 | 菜单显示顺序 |
| 状态 | 启用 | 是否显示 |

**步骤 2：添加菜单**

在目录下添加具体的菜单页面：

| 字段 | 值 | 说明 |
|------|-----|------|
| 菜单名称 | 商品列表 | 显示在侧边栏和标签页的名称 |
| 菜单类型 | 菜单 | 二级菜单 |
| 路径 | /product/list | 路由路径 |
| 组件路径 | /product/ProductList | 对应 `views/product/ProductList.vue` |
| 图标 | List | Element Plus 图标名 |
| 父级菜单 | 商品管理 | 选择上面创建的目录 |
| 排序 | 1 | 菜单显示顺序 |
| 状态 | 启用 | 是否显示 |

**步骤 3：添加按钮权限（可选）**

为菜单添加操作按钮的权限控制：

| 字段 | 值 | 说明 |
|------|-----|------|
| 菜单名称 | 添加商品 | 按钮名称 |
| 菜单类型 | 按钮 | 按钮权限 |
| 权限码 | product:add | 对应 `v-permission` 指令的值 |
| 父级菜单 | 商品列表 | 选择上面创建的菜单 |
| 排序 | 1 | 按钮显示顺序 |
| 状态 | 启用 | 是否启用 |

重复添加其他按钮权限：
- 编辑商品：`product:edit`
- 删除商品：`product:delete`
- 查看详情：`product:view`

### 5.2 组件路径规范

**路径格式：** `/模块名/组件名`

**示例：**
- `/product/ProductList` → `views/product/ProductList.vue`
- `/product/ProductDetail` → `views/product/ProductDetail.vue`
- `/user/UserList` → `views/user/list/Index.vue`

**注意：**
- 路径开头的 `/` 对应 `src/views` 目录
- 不需要写 `.vue` 后缀
- 组件路径会自动映射到实际文件

### 5.3 分配权限

在 **权限管理 → 角色管理** 中：

1. 选择需要分配权限的角色
2. 在右侧菜单树中勾选新添加的菜单和按钮
3. 点击"保存权限"

用户登录后会自动加载其角色对应的菜单和权限。

## 6. 权限控制

### 6.1 按钮权限

使用 `v-permission` 指令控制按钮显示：

```vue
<template>
  <AmButton 
    type="primary" 
    v-permission="'product:add'"
    @click="handleAdd"
  >
    添加商品
  </AmButton>
</template>
```

**权限码必须与菜单管理中配置的权限码一致。**

### 6.2 权限码规范

格式：`模块:操作`

| 权限码 | 说明 | 配置位置 |
|--------|------|----------|
| `product:list` | 查看商品列表 | 菜单管理 → 商品列表（菜单） |
| `product:add` | 添加商品 | 菜单管理 → 添加商品（按钮） |
| `product:edit` | 编辑商品 | 菜单管理 → 编辑商品（按钮） |
| `product:delete` | 删除商品 | 菜单管理 → 删除商品（按钮） |

### 6.3 权限控制流程

1. **后端配置**：在菜单管理中添加菜单和按钮权限
2. **角色分配**：在角色管理中为角色分配权限
3. **前端使用**：使用 `v-permission` 指令控制按钮显示
4. **自动加载**：用户登录后自动加载其拥有的权限

## 7. 开发检查清单

完成页面开发后，请检查：

- [ ] 使用了 Am 组件（AmButton、AmCard 等）
- [ ] 使用了 CSS 变量（间距、颜色、圆角等）
- [ ] 没有硬编码样式值
- [ ] 在菜单管理中配置了路由和权限
- [ ] 组件路径与菜单配置一致
- [ ] 添加了按钮权限配置
- [ ] 在角色管理中分配了权限
- [ ] 使用 `v-permission` 指令控制按钮
- [ ] 表单有验证规则
- [ ] 删除操作有二次确认
- [ ] 异步操作使用了 auto-loading
- [ ] 样式使用了 scoped

## 8. 下一步

页面开发完成后，可以：

1. **添加状态管理** - 参考《3.状态管理.md》（如果需要全局状态）
2. **优化用户体验** - 添加加载动画、优化交互
3. **扩展功能** - 添加导出、批量操作等

---

**提示：** 优先使用项目封装的 Am 组件和 CSS 变量，保持代码风格的一致性。
